Menu="Utilities"
Icon="terminal"
Title="WezTerm Server"
---
<?php
require_once '/usr/local/emhttp/plugins/wezterm/include/helpers.php';

$config = wezterm_read_config();
$status = wezterm_get_status();
$version = wezterm_get_version();
$certs = wezterm_list_certs();
?>

<div class="wezterm-container">
  <h2>WezTerm Multiplexing Server</h2>

  <div class="status-section">
    <h3>Status</h3>
    <table>
      <tr>
        <td>Service Status:</td>
        <td><span class="status-<?= $status['running'] ? 'running' : 'stopped' ?>"><?= $status['running'] ? 'Running' : 'Stopped' ?></span></td>
      </tr>
      <tr>
        <td>Version:</td>
        <td><?= htmlspecialchars($version) ?></td>
      </tr>
      <tr>
        <td>Listen Address:</td>
        <td><?= htmlspecialchars($config['LISTEN_ADDRESS']) ?>:<?= htmlspecialchars($config['LISTEN_PORT']) ?></td>
      </tr>
      <tr>
        <td>Client Certificates:</td>
        <td><?= count($certs) ?> issued</td>
      </tr>
    </table>
  </div>

  <div class="controls-section">
    <h3>Service Controls</h3>
    <button id="start-btn" onclick="serviceAction('start')">Start</button>
    <button id="stop-btn" onclick="serviceAction('stop')">Stop</button>
    <button id="restart-btn" onclick="serviceAction('restart')">Restart</button>

    <label>
      <input type="checkbox" id="autostart" <?= $config['SERVICE'] === 'enable' ? 'checked' : '' ?> onchange="toggleAutostart()">
      Start on boot
    </label>
  </div>

  <div class="config-section">
    <h3>Configuration</h3>
    <form id="config-form" onsubmit="saveConfig(event)">
      <table>
        <tr>
          <td>Listen Address:</td>
          <td><input type="text" name="LISTEN_ADDRESS" value="<?= htmlspecialchars($config['LISTEN_ADDRESS']) ?>"></td>
        </tr>
        <tr>
          <td>Listen Port:</td>
          <td><input type="number" name="LISTEN_PORT" value="<?= htmlspecialchars($config['LISTEN_PORT']) ?>" min="1" max="65535"></td>
        </tr>
        <tr>
          <td>Log Level:</td>
          <td>
            <select name="LOG_LEVEL">
              <option value="error" <?= $config['LOG_LEVEL'] === 'error' ? 'selected' : '' ?>>Error</option>
              <option value="warn" <?= $config['LOG_LEVEL'] === 'warn' ? 'selected' : '' ?>>Warning</option>
              <option value="info" <?= $config['LOG_LEVEL'] === 'info' ? 'selected' : '' ?>>Info</option>
              <option value="debug" <?= $config['LOG_LEVEL'] === 'debug' ? 'selected' : '' ?>>Debug</option>
              <option value="trace" <?= $config['LOG_LEVEL'] === 'trace' ? 'selected' : '' ?>>Trace</option>
            </select>
          </td>
        </tr>
      </table>
      <button type="submit">Save Configuration</button>
    </form>
  </div>

  <div class="cert-section">
    <h3>Certificate Management</h3>

    <?php if (!file_exists('/boot/config/plugins/wezterm/certs/ca.crt')): ?>
      <div class="warning">
        Certificate Authority not initialized. Click below to create CA and server certificates.
      </div>
      <button onclick="initCA()">Initialize Certificate Authority</button>
    <?php else: ?>
      <h4>Client Certificates</h4>
      <table id="cert-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Created</th>
            <th>Expires</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($certs as $cert): ?>
          <tr>
            <td><?= htmlspecialchars($cert['name']) ?></td>
            <td><?= htmlspecialchars($cert['created']) ?></td>
            <td><?= htmlspecialchars($cert['expires']) ?></td>
            <td>
              <button onclick="downloadCert('<?= htmlspecialchars($cert['name']) ?>')">Download</button>
              <button onclick="revokeCert('<?= htmlspecialchars($cert['name']) ?>')">Revoke</button>
            </td>
          </tr>
          <?php endforeach; ?>
        </tbody>
      </table>

      <h4>Generate New Client Certificate</h4>
      <form id="cert-form" onsubmit="generateCert(event)">
        <input type="text" name="cert_name" placeholder="Certificate name (e.g., laptop)" required>
        <button type="submit">Generate Certificate</button>
      </form>
    <?php endif; ?>
  </div>
</div>

<script>
function serviceAction(action) {
  $.post('/plugins/wezterm/include/exec.php', {action: action}, function(data) {
    alert(data.message);
    location.reload();
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}

function toggleAutostart() {
  var enabled = document.getElementById('autostart').checked;
  $.post('/plugins/wezterm/include/exec.php', {action: 'set_autostart', enabled: enabled ? '1' : '0'}, function(data) {
    alert(data.message);
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}

function saveConfig(event) {
  event.preventDefault();
  var formData = $(event.target).serialize() + '&action=save_config';
  $.post('/plugins/wezterm/include/exec.php', formData, function(data) {
    alert(data.message);
    location.reload();
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}

function initCA() {
  if (!confirm('Initialize Certificate Authority? This will create CA and server certificates.')) return;
  $.post('/plugins/wezterm/include/exec.php', {action: 'init_ca'}, function(data) {
    alert(data.message);
    location.reload();
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}

function generateCert(event) {
  event.preventDefault();
  var formData = $(event.target).serialize() + '&action=generate_cert';
  $.post('/plugins/wezterm/include/exec.php', formData, function(data) {
    alert(data.message);
    location.reload();
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}

function downloadCert(name) {
  window.location.href = '/plugins/wezterm/include/exec.php?action=download_cert&name=' + encodeURIComponent(name);
}

function revokeCert(name) {
  if (!confirm('Revoke certificate for ' + name + '?')) return;
  $.post('/plugins/wezterm/include/exec.php', {action: 'revoke_cert', name: name}, function(data) {
    alert(data.message);
    location.reload();
  }, 'json').fail(function(xhr) {
    alert('Error: ' + xhr.responseText);
  });
}
</script>

<style>
.wezterm-container {
  max-width: 1000px;
  margin: 20px auto;
  color: var(--text-color);
}
.wezterm-container h2,
.wezterm-container h3,
.wezterm-container h4 {
  color: var(--text-color);
}
.wezterm-container table {
  border-collapse: collapse;
  background-color: var(--table-background-color);
}
.wezterm-container table th {
  background-color: var(--table-header-background-color);
  color: var(--text-color);
  padding: 8px;
  text-align: left;
  border: 1px solid var(--table-border-color);
}
.wezterm-container table td {
  padding: 8px;
  border: 1px solid var(--table-border-color);
  color: var(--text-color);
}
.wezterm-container table tr:hover {
  background-color: var(--hover-table-row-background-color);
}
.wezterm-container input[type="text"],
.wezterm-container input[type="number"],
.wezterm-container select {
  background-color: var(--input-bg-color);
  color: var(--text-color);
  border: 1px solid var(--input-border-color);
  padding: 4px 8px;
}
.wezterm-container input[type="text"]:focus,
.wezterm-container input[type="number"]:focus,
.wezterm-container select:focus {
  background-color: var(--focus-input-bg-color);
}
.wezterm-container label {
  color: var(--text-color);
}
.status-running { color: var(--green-500); font-weight: bold; }
.status-stopped { color: var(--red-500); font-weight: bold; }
.wezterm-warning {
  padding: 10px;
  margin: 10px 0;
  border-radius: 4px;
  background-color: var(--mild-background-color);
  border: 1px solid var(--border-color);
  color: var(--text-color);
}
.config-section, .controls-section, .status-section, .cert-section {
  margin: 20px 0;
  padding: 15px;
  border-radius: 5px;
  background-color: var(--mild-background-color);
  border: 1px solid var(--border-color);
}
</style>
